from malwareDetector.detector import detector
from config import subDetectorConfig
import os
import r2pipe
import pandas as pd

def disassemble_helper(file_name):
    pp = Preprocess(file_name)
    pp.disassemble()

class Preprocess(detector):
    def __init__(self, file_name):
        super().__init__()
        self.config = subDetectorConfig()
        self.name = file_name
        self.input_file_path = os.path.join(self.config.baseConfig.path.input, file_name)
        self.output_csv_path = os.path.join(self.config.baseConfig.folder.disassemble, f'{file_name}.csv')

    def disassemble(self):
        try:
            # open the file
            r2 = r2pipe.open(self.input_file_path)
            print(f"Successfully opened file {self.name}.")
            # disassemble
            r2.cmd("aaaa")
            df = pd.DataFrame(r2.cmdj("pDj $SS@$S"))
            print(f"Successfully disassembled file {self.name}.")
            # retrieve the required information
            df_split = df['opcode'].str.split(expand=True)
            df = pd.concat([df, df_split], axis=1)
            df.rename(columns = {'opcode': 'dropOp', 0: 'opcode'}, inplace=True)
            df = df['opcode']
            # save the file
            df.to_csv(self.output_csv_path)
            print("Save as a .csv file.")
        except Exception as e:
            print("An exception occurred:", type(e))