import helper
import r2pipe
import pandas as pd

class preprocess:
    def __init__(self, wt, directory_path, file_name):
        self.dir_path = directory_path + '/{}'.format(wt)
        self.input_file_path = helper.get_file_path(self.dir_path, file_name)
        self.output_json_path = './01_json/{}/{}.json'.format(wt, file_name)
        self.output_csv_path = './02_csv/{}/{}.json'.format(wt, file_name)

    def disam(self):
        r2 = r2pipe.open(self.input_file_path)
        r2.cmd("aa")
        r2.cmd("pdaj > {}".format(self.output_json_path))

    def convert_to_csv(self):
        df = pd.read_json(self.output_json_path)
        df_split = df['inst'].str.split(expand=True)
        df = pd.concat([df, df_split], axis=1)
        df.rename(columns = {0: 'opcode'}, inplace=True)
        df.drop(['bytes', 'inst', 1, 2, 3], axis=1, inplace=True)
        df.to_csv(self.output_csv_path)

    def preprocess_helper(self):
        self.disam()
        self.convert_to_csv()