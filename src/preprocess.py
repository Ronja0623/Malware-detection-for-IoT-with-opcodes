from malware_detector import MalwareDetector
import r2pipe
import pandas as pd

def disam_helper(file_name):
    pp = Preprocess(file_name)
    pp.disam()

def convert_to_csv_helper(file_name):
    pp = Preprocess(file_name)
    pp.convert_to_csv()

class Preprocess(MalwareDetector):
    def __init__(self, file_name):
        super().__init__()
        self.input_file_path = self.get_file_path(self.dataset_dir_path, file_name)
        self.output_json_path = self.output_json_opcode_dir_path + '/{}.json'.format(file_name)
        self.output_csv_path = self.output_csv_opcode_dir_path + '/{}.csv'.format(file_name)

    def disam(self):
        r2 = r2pipe.open(self.input_file_path)
        r2.cmd("aa")
        r2.cmd("pdaj > {}".format(self.output_json_path))

    def convert_to_csv(self):
        df = pd.read_json(self.output_json_path)
        df_split = df['inst'].str.split(expand=True)
        df = pd.concat([df, df_split], axis=1)
        df.rename(columns = {0: 'opcode'}, inplace=True)
        df.drop(['bytes', 'inst', 1, 2, 3], axis=1, inplace=True)
        df.to_csv(self.output_csv_path)