from malware_detector import MalwareDetector
import r2pipe
import pandas as pd

def disassemble_helper(file_name):
    pp = Preprocess(file_name)
    pp.disassemble()

class Preprocess(MalwareDetector):
    def __init__(self, file_name):
        super().__init__()
        self.input_file_path = self.get_file_path(self.dataset_dir_path, file_name)
        self.output_json_path = self.output_json_opcode_dir_path + '/{}.json'.format(file_name)
        self.output_csv_path = self.output_csv_opcode_dir_path + '/{}.csv'.format(file_name)

    def disassemble(self):
        # open the file
        r2 = r2pipe.open(self.input_file_path)
        # disassemble
        r2.cmd("aa")
        r2.cmd("aa")
        df = pd.DataFrame(r2.cmdj("pDj $SS@$S"))
        # retrieve the required information
        df_split = df['opcode'].str.split(expand=True)
        df = pd.concat([df, df_split], axis=1)
        df = df[['offset', 0]]
        df.rename(columns = {'offset': 'addr', 0: 'opcode'}, inplace=True)
        # save the file
        df.to_csv(self.output_csv_path)