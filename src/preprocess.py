from malwareDetector.detector import detector
import os
import r2pipe
import pandas as pd

def disassemble_helper(file_name):
    pp = Preprocess(file_name)
    pp.disassemble()

class Preprocess(detector):
    def __init__(self, file_name):
        super().__init__()
        self.config.folder.set_folder("disassemble", "Disassemble")
        self.name = file_name
        self.input_file_path = os.path.join(self.config.path.input, file_name)
        self.output_csv_path = self.config.folder.disassemble + '{}.csv'.format(file_name)

    def disassemble(self):
        # open the file
        r2 = r2pipe.open(self.input_file_path)
        print(f"Successfully opened file {self.name}.")
        # disassemble
        r2.cmd("aa")
        df = pd.DataFrame(r2.cmdj("pDj $SS@$S"))
        print(f"Successfully disassembled file {self.name}.")
        # retrieve the required information
        df_split = df['opcode'].str.split(expand=True)
        df = pd.concat([df, df_split], axis=1)
        df = df[['offset', 0]]
        df.rename(columns = {'offset': 'addr', 0: 'opcode'}, inplace=True)
        # save the file
        df.to_csv(self.output_csv_path)
        print("Save as a .csv file.")