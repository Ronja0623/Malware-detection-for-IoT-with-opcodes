import helper
import numpy as np
import pandas as pd
from math import e

def string_to_tuple(str):
    return tuple(str.split())

class vectorization:
    def __init__(self, df_feature, wt, file_name):
        self.input_file_path = './02_csv/{}/{}.json'.format(wt, file_name)
        self.output_file_path = './04_graph/{}/{}.csv'.format(wt, file_name)
        self.df_feature = df_feature
        self.df_sample = pd.read_csv(self.input_file_path)
        self.size = len(df_feature)
        self.affinity_matrix = np.zeros((self.size, self.size))

    def check_n_gram(self, index):
        addr_list = []
        feature = self.df_feature.iloc[index]
        for data in self.df_sample:
            if data['opcode'] != feature['n_gram'][0]:
                continue
            cur = self.df_sample.index(data)
            isGot = True
            for i in (1, feature['n(n_gram)']):
                cur += 1
                if cur >= len(self.df_sample):
                    isGot = False
                    break
                if self.df_sample[cur]['opcode'] != feature['n_gram'][i]:
                    isGot = False
                    break
            if isGot:
                addr_list.append(data['addr'])
        return addr_list

    def get_E_value(self, i, j):
        addr_list_i = self.check_n_gram(i)
        addr_list_j = self.check_n_gram(j)
        E_value = 0
        for s in addr_list_i:
            E_value += 2 / (1 + e ** abs(min(addr_list_j, key=lambda x: abs(x - s)) - s))
        return E_value
    
    def get_affinity_matrix(self):
        for i in range(self.size):
            for j in range(self.size):
                self.affinity_matrix[i][j] = self.get_E_value(i, j)
    
    def row_normalize(self):
        row_norms = np.linalg.norm(self.affinity_matrix, axis=1, keepdims=True)
        self.affinity_matrix /= row_norms

    def vectorization_helper(self):
        self.get_affinity_matrix()
        self.row_normalize()
        np.savetxt(self.output_file_path, self.affinity_matrix, delimiter=',')
